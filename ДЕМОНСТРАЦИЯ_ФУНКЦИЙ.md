# –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —Ñ—É–Ω–∫—Ü–∏–π Django ORM

–≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç –æ–ø–∏—Å—ã–≤–∞–µ—Ç, –∫–∞–∫ –ø—Ä–æ–¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ —Ç—Ä–µ–±—É–µ–º—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ Django ORM –≤ –ø—Ä–æ–µ–∫—Ç–µ.

## üîß –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏

### 1. ‚úÖ ManyToManyField —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º through

**–ß—Ç–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ:**
- `User.roles` - —Å–≤—è–∑—å —á–µ—Ä–µ–∑ –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—É—é –º–æ–¥–µ–ª—å `UserRole`
- `Book.genres` - —Å–≤—è–∑—å —á–µ—Ä–µ–∑ –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—É—é –º–æ–¥–µ–ª—å `BookGenre`

**–ö–æ–¥ –º–æ–¥–µ–ª–µ–π:**
```python
# –í –º–æ–¥–µ–ª–∏ User
roles = models.ManyToManyField('Role', through='UserRole', related_name='users', verbose_name=_('–†–æ–ª–∏'))

# –í –º–æ–¥–µ–ª–∏ Book
genres = models.ManyToManyField(Genre, through='BookGenre', related_name='books', verbose_name=_('–ñ–∞–Ω—Ä—ã'))

# –ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ –º–æ–¥–µ–ª–∏
class UserRole(models.Model):
    user = models.ForeignKey(User, on_delete=models.CASCADE, related_name='user_roles')
    role = models.ForeignKey(Role, on_delete=models.CASCADE, related_name='user_roles')
    created_at = models.DateTimeField(auto_now_add=True)

class BookGenre(models.Model):
    book = models.ForeignKey(Book, on_delete=models.CASCADE, related_name='book_genres')
    genre = models.ForeignKey(Genre, on_delete=models.CASCADE, related_name='book_genres')
    created_at = models.DateTimeField(auto_now_add=True)
```

### 2. ‚úÖ select_related()

**–ß—Ç–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ:**
- –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è ForeignKey —Å–≤—è–∑–µ–π (book ‚Üí author)
- –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è OneToOneField —Å–≤—è–∑–µ–π (book ‚Üí cover)
- –¶–µ–ø–æ—á–∫–∏ select_related (review ‚Üí user, book, book__author)

**–ü—Ä–∏–º–µ—Ä—ã –∫–æ–¥–∞:**
```python
# –ü—Ä–æ—Å—Ç–æ–π select_related
books_with_author = Book.objects.select_related('author')

# –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π select_related
books_optimized = Book.objects.select_related('author', 'cover')

# –¶–µ–ø–æ—á–∫–∞ —Å–≤—è–∑–µ–π
reviews_with_user_and_book = Review.objects.select_related('user', 'book', 'book__author')
```

### 3. ‚úÖ prefetch_related()

**–ß—Ç–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ:**
- –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è ManyToMany —Å–≤—è–∑–µ–π (book ‚Üí genres)
- –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –æ–±—Ä–∞—Ç–Ω—ã—Ö ForeignKey —Å–≤—è–∑–µ–π (book ‚Üí reviews)
- –ö–æ–º–±–∏–Ω–∞—Ü–∏—è —Å Prefetch –¥–ª—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

**–ü—Ä–∏–º–µ—Ä—ã –∫–æ–¥–∞:**
```python
# –ü—Ä–æ—Å—Ç–æ–π prefetch_related
books_with_reviews = Book.objects.prefetch_related('reviews')
books_with_genres = Book.objects.prefetch_related('genres')

# –°–ª–æ–∂–Ω—ã–π prefetch_related —Å Prefetch
books_complex = Book.objects.select_related('author').prefetch_related(
    Prefetch('reviews', queryset=Review.objects.select_related('user')),
    Prefetch('genres'),
    Prefetch('book_genres', queryset=BookGenre.objects.select_related('genre'))
)
```

## üöÄ –ö–∞–∫ –ø—Ä–æ–¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª

### –ú–µ—Ç–æ–¥ 1: –í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å (–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

1. **–ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä:**
```bash
python manage.py runserver
```

2. **–°–æ–∑–¥–∞–π—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ:**
```bash
python manage.py create_demo_data
```

3. **–û—Ç–∫—Ä–æ–π—Ç–µ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É:**
```
http://127.0.0.1:8000/books/demo/
```

**–ß—Ç–æ –≤—ã —É–≤–∏–¥–∏—Ç–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ:**
- –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—é ManyToManyField —Å through (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏-—Ä–æ–ª–∏, –∫–Ω–∏–≥–∏-–∂–∞–Ω—Ä—ã)
- –ü—Ä–∏–º–µ—Ä—ã —Ä–∞–±–æ—Ç—ã select_related (–∫–Ω–∏–≥–∏ —Å –∞–≤—Ç–æ—Ä–∞–º–∏, –æ—Ç–∑—ã–≤—ã —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏)
- –ü—Ä–∏–º–µ—Ä—ã —Ä–∞–±–æ—Ç—ã prefetch_related (–∫–Ω–∏–≥–∏ —Å –æ—Ç–∑—ã–≤–∞–º–∏, –∞–≤—Ç–æ—Ä—ã —Å –∫–Ω–∏–≥–∞–º–∏)
- –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–∞ —á–µ—Ä–µ–∑ ManyToManyField –∏ –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—É—é –º–æ–¥–µ–ª—å
- –ü–æ–∫–∞–∑ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

### –ú–µ—Ç–æ–¥ 2: Django Admin

1. **–°–æ–∑–¥–∞–π—Ç–µ —Å—É–ø–µ—Ä–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:**
```bash
python manage.py createsuperuser
```

2. **–ó–∞–π–¥–∏—Ç–µ –≤ –∞–¥–º–∏–Ω–∫—É:**
```
http://127.0.0.1:8000/admin/
```

3. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–∞–Ω–Ω—ã–µ –≤ —Ä–∞–∑–¥–µ–ª–∞—Ö:**
- Users ‚Üí User roles (–ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–∞—è –º–æ–¥–µ–ª—å UserRole)
- Books ‚Üí Book genres (–ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–∞—è –º–æ–¥–µ–ª—å BookGenre)
- Books ‚Üí Books (—Å select_related –∏ prefetch_related –≤ –∞–¥–º–∏–Ω–∫–µ)

### –ú–µ—Ç–æ–¥ 3: Django Shell

1. **–ó–∞–ø—É—Å—Ç–∏—Ç–µ shell:**
```bash
python manage.py shell
```

2. **–í—ã–ø–æ–ª–Ω–∏—Ç–µ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã:**

```python
from books.models import *
from django.db.models import Prefetch

# === ManyToManyField —Å through ===

# –ü–æ–ª—É—á–µ–Ω–∏–µ —Ä–æ–ª–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —á–µ—Ä–µ–∑ ManyToManyField
user = User.objects.first()
roles_m2m = user.roles.all()
print("–†–æ–ª–∏ —á–µ—Ä–µ–∑ M2M:", [role.name for role in roles_m2m])

# –ü–æ–ª—É—á–µ–Ω–∏–µ —Ä–æ–ª–µ–π —á–µ—Ä–µ–∑ –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—É—é –º–æ–¥–µ–ª—å
roles_through = UserRole.objects.filter(user=user).select_related('role')
print("–†–æ–ª–∏ —á–µ—Ä–µ–∑ through:", [(ur.role.name, ur.created_at) for ur in roles_through])

# –ü–æ–ª—É—á–µ–Ω–∏–µ –∂–∞–Ω—Ä–æ–≤ –∫–Ω–∏–≥–∏ —á–µ—Ä–µ–∑ ManyToManyField
book = Book.objects.first()
genres_m2m = book.genres.all()
print("–ñ–∞–Ω—Ä—ã —á–µ—Ä–µ–∑ M2M:", [genre.name for genre in genres_m2m])

# –ü–æ–ª—É—á–µ–Ω–∏–µ –∂–∞–Ω—Ä–æ–≤ —á–µ—Ä–µ–∑ –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—É—é –º–æ–¥–µ–ª—å
genres_through = BookGenre.objects.filter(book=book).select_related('genre')
print("–ñ–∞–Ω—Ä—ã —á–µ—Ä–µ–∑ through:", [(bg.genre.name, bg.created_at) for bg in genres_through])

# === select_related ===

# –ë–µ–∑ select_related (–º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã)
books_slow = Book.objects.all()
for book in books_slow:
    print(f"{book.title} - {book.author.name}")  # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∞–≤—Ç–æ—Ä–∞

# –° select_related (–æ–¥–∏–Ω –∑–∞–ø—Ä–æ—Å —Å JOIN)
books_fast = Book.objects.select_related('author')
for book in books_fast:
    print(f"{book.title} - {book.author.name}")  # –ë–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

# === prefetch_related ===

# –ë–µ–∑ prefetch_related (N+1 –ø—Ä–æ–±–ª–µ–º–∞)
books_slow = Book.objects.all()
for book in books_slow:
    reviews = book.reviews.all()  # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å –¥–ª—è –∫–∞–∂–¥–æ–π –∫–Ω–∏–≥–∏
    print(f"{book.title}: {len(reviews)} –æ—Ç–∑—ã–≤–æ–≤")

# –° prefetch_related (–¥–≤–∞ –∑–∞–ø—Ä–æ—Å–∞ –≤–º–µ—Å—Ç–æ N+1)
books_fast = Book.objects.prefetch_related('reviews')
for book in books_fast:
    reviews = book.reviews.all()  # –ë–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
    print(f"{book.title}: {len(reviews)} –æ—Ç–∑—ã–≤–æ–≤")

# –ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è
optimized_books = Book.objects.select_related('author').prefetch_related(
    Prefetch('reviews', queryset=Review.objects.select_related('user')),
    'genres'
)

for book in optimized_books:
    print(f"\n–ö–Ω–∏–≥–∞: {book.title}")
    print(f"–ê–≤—Ç–æ—Ä: {book.author.name}")
    print(f"–ñ–∞–Ω—Ä—ã: {', '.join([g.name for g in book.genres.all()])}")
    print("–û—Ç–∑—ã–≤—ã:")
    for review in book.reviews.all():
        print(f"  - {review.user.username}: {review.rating}/5")
```

### –ú–µ—Ç–æ–¥ 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ SQL –∑–∞–ø—Ä–æ—Å–æ–≤

–î–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∑–∞–ø—Ä–æ—Å–æ–≤:

```python
from django.db import connection
from django.conf import settings

# –í–∫–ª—é—á–∏—Ç–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤
settings.DEBUG = True

# –°–±—Ä–æ—Å—å—Ç–µ —Å—á–µ—Ç—á–∏–∫ –∑–∞–ø—Ä–æ—Å–æ–≤
connection.queries_log.clear()

# –í—ã–ø–æ–ª–Ω–∏—Ç–µ –∫–æ–¥ —Å select_related
books = Book.objects.select_related('author')[:5]
for book in books:
    print(f"{book.title} - {book.author.name}")

print(f"–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ SQL –∑–∞–ø—Ä–æ—Å–æ–≤: {len(connection.queries)}")
print("–ü–æ—Å–ª–µ–¥–Ω–∏–π –∑–∞–ø—Ä–æ—Å:")
print(connection.queries[-1]['sql'])
```

## üìä –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

### ManyToManyField —Å through:
- –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø–æ–ª—É—á–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –∫–∞–∫ —á–µ—Ä–µ–∑ ManyToManyField, —Ç–∞–∫ –∏ —á–µ—Ä–µ–∑ –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—É—é –º–æ–¥–µ–ª—å
- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –≤ –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–æ–π –º–æ–¥–µ–ª–∏ (created_at)
- –û–¥–∏–Ω–∞–∫–æ–≤—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã, –Ω–æ —Ä–∞–∑–Ω—ã–µ —Å–ø–æ—Å–æ–±—ã –¥–æ—Å—Ç—É–ø–∞

### select_related:
- –£–º–µ–Ω—å—à–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ SQL –∑–∞–ø—Ä–æ—Å–æ–≤ —Å N+1 –¥–æ 1
- JOIN –≤ SQL –∑–∞–ø—Ä–æ—Å–µ
- –ë—ã—Å—Ç—Ä–∞—è —Ä–∞–±–æ—Ç–∞ —Å ForeignKey –∏ OneToOneField

### prefetch_related:
- –£–º–µ–Ω—å—à–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ SQL –∑–∞–ø—Ä–æ—Å–æ–≤ —Å N+1 –¥–æ 2
- –û—Ç–¥–µ–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –¥–ª—è —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü
- –ë—ã—Å—Ç—Ä–∞—è —Ä–∞–±–æ—Ç–∞ —Å ManyToManyField –∏ –æ–±—Ä–∞—Ç–Ω—ã–º–∏ ForeignKey

## üéØ –û—Å–Ω–æ–≤–Ω—ã–µ URL –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏

- **–ì–ª–∞–≤–Ω–∞—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è:** `/books/demo/`
- **–°–ø–∏—Å–æ–∫ –∫–Ω–∏–≥ —Å –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–µ–π:** `/books/`
- **–î–µ—Ç–∞–ª–∏ –∫–Ω–∏–≥–∏:** `/books/book/<id>/`
- **–ê–¥–º–∏–Ω–∫–∞:** `/admin/`

## üìù –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–í—Å–µ —Ç—Ä–∏ —Ç—Ä–µ–±—É–µ–º—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ (`ManyToManyField` —Å `through`, `select_related()`, `prefetch_related()`) –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã –∏ –º–æ–≥—É—Ç –±—ã—Ç—å –ø—Ä–æ–¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã —Ä–∞–∑–Ω—ã–º–∏ —Å–ø–æ—Å–æ–±–∞–º–∏. –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –Ω–∞–≥–ª—è–¥–Ω–æ–π –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ –≤—Å–µ—Ö –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π. 